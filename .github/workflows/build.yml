name: Build to AWS ECR
on: push

jobs: 
  login-to-aws:
     runs-on: ubuntu-latest
     steps:

     - name: Code Checkout
       uses: actions/checkout@v4

     - name: Login to AWS
       uses: aws-actions/configure-aws-credentials@v4
       with:
          aws-access-key-id: ${{secrets.ACCESS_KEY}}
          aws-secret-access-key: ${{secrets.SECRET_ACCESS_KEY}}
          aws-region: ${{secrets.REGION}}
          
build-and-push-private-ecr:
      runs-on: ubuntu-latest
      needs:
      - login-to-aws
      steps:

      - name: Code Checkout
      uses: actions/checkout@v3
       - name: Login to AWS ECR
      uses: docker/login-action@v2
          with:
        registry: 846265175058.dkr.ecr.us-east-1.amazonaws.com
        username: ${{ secrets.AWS_ACCESS_KEY_ID }}
        password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Build and Push Image
      env:
        ECR_REGISTRY: 846265175058.dkr.ecr.us-east-1.amazonaws.com
        ECR_REPOSITORY: arize-api
        IMAGE_TAG: v11
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
